generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Tracks each Facebook post through the delivery pipeline
model Post {
  id           String      @id @default(cuid())
  fbPostId     String      @unique @map("fb_post_id")
  status       PostStatus  @default(received)
  authorId     String?     @map("author_id")
  authorName   String?     @map("author_name")
  message      String?
  permalink    String?
  createdAt    DateTime?   @map("fb_created_at")
  discordMsgId String?     @map("discord_msg_id")
  deliveredAt  DateTime?   @map("delivered_at")
  lastError    String?     @map("last_error")
  retryCount   Int         @default(0) @map("retry_count")
  receivedAt   DateTime    @default(now()) @map("received_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  events       PostEvent[]

  @@index([status])
  @@index([receivedAt])
  @@map("posts")
}

/// Audit log for post state transitions and events
model PostEvent {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  event     String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
  @@map("post_events")
}

/// Delivery log for operational monitoring
model DeliveryLog {
  id           String   @id @default(cuid())
  fbPostId     String   @map("fb_post_id")
  success      Boolean
  discordMsgId String?  @map("discord_msg_id")
  errorMessage String?  @map("error_message")
  latencyMs    Int?     @map("latency_ms")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([success])
  @@map("delivery_logs")
}

/// Post processing state machine
/// States: received → fetching → eligible → sending → delivered
/// Terminal: ignored (no tag), failed (hard fail), needs_review (ambiguous delivery)
enum PostStatus {
  received
  fetching
  eligible
  ignored
  sending
  delivered
  failed
  needs_review
}
